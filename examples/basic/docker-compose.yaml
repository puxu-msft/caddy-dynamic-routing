version: "3.8"

services:
  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    command:
      - etcd
      - --name=etcd0
      - --advertise-client-urls=http://etcd:2379
      - --listen-client-urls=http://0.0.0.0:2379
    ports:
      - "2379:2379"
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 10s
      timeout: 5s
      retries: 3

  backend1:
    image: nginx:alpine
    volumes:
      - ./nginx-backend1.conf:/etc/nginx/nginx.conf:ro

  backend2:
    image: nginx:alpine
    volumes:
      - ./nginx-backend2.conf:/etc/nginx/nginx.conf:ro

  backend3:
    image: nginx:alpine
    volumes:
      - ./nginx-backend3.conf:/etc/nginx/nginx.conf:ro

  caddy:
    build:
      context: ../..
      dockerfile: docker/Dockerfile
    ports:
      - "80:80"
      - "443:443"
      - "2019:2019"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - etcd
      - backend1
      - backend2
      - backend3

  # Setup initial routes
  setup:
    image: quay.io/coreos/etcd:v3.5.9
    depends_on:
      etcd:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        etcdctl --endpoints=http://etcd:2379 put /caddy/routing/tenant-a "backend1:80"
        etcdctl --endpoints=http://etcd:2379 put /caddy/routing/tenant-b "backend2:80"
        etcdctl --endpoints=http://etcd:2379 put /caddy/routing/tenant-c "backend3:80"
        echo "Routes configured successfully"
