services:
  # etcd - configuration store
  etcd:
    image: quay.io/coreos/etcd:v3.5.17
    container_name: caddy-dynamic-routing-etcd
    environment:
      - ETCD_NAME=etcd0
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_CLUSTER=etcd0=http://etcd:2380
    ports:
      - "2379:2379"
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 5s
      timeout: 3s
      retries: 5

  # backend service - Tenant A
  backend-a:
    image: hashicorp/http-echo:latest
    container_name: caddy-dynamic-routing-backend-a
    command: ["-text=Hello from Backend A (tenant-a)"]
    expose:
      - "5678"

  # backend service - Tenant B
  backend-b:
    image: hashicorp/http-echo:latest
    container_name: caddy-dynamic-routing-backend-b
    command: ["-text=Hello from Backend B (tenant-b)"]
    expose:
      - "5678"

  # backend service - Default
  backend-default:
    image: hashicorp/http-echo:latest
    container_name: caddy-dynamic-routing-backend-default
    command: ["-text=Hello from Default Backend (fallback)"]
    expose:
      - "5678"

  # Caddy with this plugin
  caddy:
    build:
      context: ../..
      dockerfile: docker/Dockerfile
    container_name: caddy-dynamic-routing-caddy
    ports:
      - "8080:8080"
      - "2019:2019" # Admin API
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      etcd:
        condition: service_healthy
      backend-a:
        condition: service_started
      backend-b:
        condition: service_started
      backend-default:
        condition: service_started

  # etcd initialization - set up routing rules
  etcd-init:
    image: alpine:latest
    container_name: caddy-dynamic-routing-etcd-init
    depends_on:
      etcd:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache etcd-ctl

        echo "Setting up routing rules in etcd..."

        etcdctl --endpoints=http://etcd:2379 put /caddy/routing/tenant-a "backend-a:5678"
        echo "Added route: tenant-a -> backend-a:5678"

        etcdctl --endpoints=http://etcd:2379 put /caddy/routing/tenant-b "backend-b:5678"
        echo "Added route: tenant-b -> backend-b:5678"

        etcdctl --endpoints=http://etcd:2379 put /caddy/routing/tenant-advanced '{
          "rules": [
            {
              "match": {"http.request.header.X-Version": "v2"},
              "upstreams": [{"address": "backend-b:5678", "weight": 100}],
              "priority": 10
            },
            {
              "match": {},
              "upstreams": [{"address": "backend-a:5678", "weight": 100}],
              "priority": 0
            }
          ],
          "fallback": "random"
        }'
        echo "Added route: tenant-advanced (conditional)"

        echo ""
        echo "=== All routing rules ==="
        etcdctl --endpoints=http://etcd:2379 get /caddy/routing/ --prefix

        echo ""
        echo "Routing setup complete!"
